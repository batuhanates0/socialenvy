$(function(){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};emojione.imageType="png";emojione.imagePathPNG="/lib/emojione/png/";emojify.setConfig({img_dir:"/lib/emojify.js/images/basic",ignore_emoticons:true});$(".fancybox").fancybox({padding:0});$("*[data-checked]").each(function(){var $inp=$(this);$inp.prop("checked",$inp.data("checked"))});$("*[data-selected]").each(function(){var $inp=$(this);$inp.find('option[value="'+$inp.data("selected")+'"]').prop("selected",true)});$("*[data-disabled]").each(function(){var $inp=$(this);$inp.prop("disabled",$inp.data("disabled"))});$("*[data-hidden]").each(function(){var $el=$(this),hidden=$el.data("hidden");if(hidden){$el.hide().addClass("hidden")}else{$el.show().removeClass("hidden")}});$('[data-toggle="tooltip"]').tooltip({animation:false,html:true,placement:"top",trigger:"hover focus",container:"body"});$('[data-toggle="popover"], .help-tip').popover({animation:false,html:true,placement:"top",trigger:"hover focus",container:"body"});$("[data-ui-menu-toggle]").on("click",function(e){e.preventDefault();e.stopPropagation();var $btn=$(this);var selector="[data-ui="+$btn.data("ui-menu-toggle")+"]";var $menu=$btn.data("ui-role")==="dropdown"?$btn.parent().find(selector):$(selector);if($menu.is(":hidden")){$(document).trigger("click")}$(document).one("click",function(){$btn.removeClass("active");$menu.hide()});$btn.toggleClass("active");$menu.toggle()});$(document.body).on("popup.do-close",".popup",function(){var popupId=$(this).attr("id");if(!popupId){throw new Error("Popup without ID attribute cannot be closed this way")}var $popup=$("#"+popupId);$popup.popupClose();var formsTriggered=0;$("form",$popup).each(function(){var $form=$(this);$form.trigger("popup.close");formsTriggered++});if(formsTriggered===0){$popup.trigger("popup.close")}});$(document.body).on("popup.do-open",".popup",function(){var popupId=$(this).attr("id");if(!popupId){throw new Error("Popup without ID attribute cannot be opened this way")}var $popup=$("#"+popupId);$popup.popup({shadow:true});$popup.find("*[autofocus]").focus();var formsTriggered=0;$("form",$popup).each(function(){var $form=$(this);$form.trigger("popup.open");formsTriggered++});if(formsTriggered===0){$popup.trigger("popup.open")}});$(document.body).on("click","*[data-popup-close]",function(e){e.preventDefault();var $btn=$(this);var $popup=$($btn.data("popup-close"));if($popup.data("popup-modal")){return}$popup.trigger("popup.do-close")});$(document.body).on("click","*[data-popup-open]",function(e){e.preventDefault();var $btn=$(this);var $popup=$($btn.data("popup-open"));$popup.trigger("popup.do-open")});$("*[data-popup-auto]").each(function(){var popupId=$(this).attr("id");if(!popupId){throw new Error("Popup without ID attribute cannot be auto-opened this way")}var $popup=$("#"+popupId);if($popup.data("popup-auto")){$popup.trigger("popup.do-open")}});(function(){var $popup=$("#popup-support"),$form=$("form",$popup),$inp=$("input[name=token]",$form);$popup.on("popup.open",function(){$.ajax({url:"/support/token/create",type:"post",dataType:"json"}).done(function(data){if(data.status==="ok"){$inp.val(data.token)}else{if(data.error){}}}).fail(function(){})});$popup.on("popup.close",function(){$.ajax({url:"/support/token/remove/"+$inp.val(),type:"post",dataType:"json"}).done(function(data){if(data.status==="ok"){$inp.val("")}else{if(data.error){}}}).fail(function(){})})})();$(document.body).on("click","*[data-confirm]",function(e){if(!confirm($(this).data("confirm"))){e.preventDefault()}});$("form.form-ajax").each(function(){var $form=$(this);var $submit=$("*[type=submit]",$form);var $inputs=$("input, select, textarea, button",$form);var $alerts=$form.parent().find(".alerts .alert");var $alertSuccess=$alerts.filter(".alert-success");var $alertErrors=$alerts.filter(".alert-error");var $fieldWraps=$(".field-wrap",$form);var $fieldErrors=$(".text-error",$fieldWraps);$form.on("submit",function(e){e.preventDefault();var action=$form.attr("action");var method=$form.attr("method");var params=helper.formArrayToObject($form.serializeArray());$submit.button("loading");$inputs.prop("disabled",true);$alerts.html("").hide().addClass("hidden");$fieldWraps.removeClass("error");$fieldErrors.text("").addClass("hidden");$.ajax({url:action,type:method,data:params,dataType:"json"}).done(function(data){if(data.debug){console.log(data.debug)}if(data.message){alert(data.message)}if(data.success){$alertSuccess.html("<div>"+data.success+"</div>").show().removeClass("hidden")}if(data.error){$alertErrors.html("<div>"+data.error+"</div>").show().removeClass("hidden")}if(data.errors){var errorsHtml="";for(var i=0;i<data.errors.length;i++){errorsHtml+="<div>"+data.errors[i]+"</div>"}$alertErrors.html(errorsHtml).show().removeClass("hidden")}if(data.validationErrors){for(var j=0;j<data.validationErrors.length;j++){var err=data.validationErrors[j];var errText=_.isObject(err)&&err.msg?err.msg:null;var errField=_.isObject(err)&&err.param?err.param:null;if(errText!==null&&errField!==null){var $fieldWrap=$fieldWraps.filter("[data-field="+errField+"]");$fieldWrap.addClass("error");$(".text-error",$fieldWrap).text(errText).removeClass("hidden")}}}if(data.redirect){document.location=data.redirect}if(data.formReset){$form.get(0).reset()}if(data.formHide){$form.hide().addClass("hidden")}if(data.event){var eventData=data.eventData||{};$form.trigger(data.event,eventData)}}).fail(function(){alert("Unexpected server error")}).always(function(){$submit.button("reset");$inputs.filter(":not([data-disabled=1],[data-disabled=true])").prop("disabled",false)})});$form.on("popup.reset",function(){if($form.data("persist")===true){return}if(!$form.data("fields-persist")){$form.show().removeClass("hidden").get(0).reset()}$alerts.html("").hide().addClass("hidden");$inputs.filter(":not([data-disabled=1],[data-disabled=true])").prop("disabled",false);$fieldWraps.removeClass("error");$fieldErrors.text("").addClass("hidden");$submit.button("reset")});$form.on("popup.close",function(){$form.trigger("popup.reset")});$form.on("popup.open",function(){$form.trigger("popup.reset")})});$(document.body).on("click",".unit-username-select, .unit-location-select",function(e){var $unit=$(this),$chk=$unit.find("input[type=checkbox]"),$trg=$(e.target);if($trg.attr("for")===$chk.attr("id")||$trg.attr("id")===$chk.attr("id")){return}$chk.prop("checked",!$chk.prop("checked")).trigger("change").focus()});$(".btnMediaLoad").each(function(){var $btn=$(this);var $cont=$($btn.data("container"));var endpoint=$btn.data("endpoint");var loading=false;if(!$btn.data("next_max_id")){$btn.hide().addClass("hidden")}$btn.on("click",function(){var next_max_id=$btn.data("next_max_id");if(!next_max_id){$btn.hide().addClass("hidden");return}$btn.button("loading");loading=true;$.ajax({url:endpoint,data:{max_id:next_max_id},dataType:"json"}).done(function(data){if(data.debug){console.log(data.debug)}if(data.error){alert(data.error);return}else if(data.errors){alert(data.errors.join("\n"));return}$cont.append(data.media_html);$btn.data("next_max_id",data.next_max_id);if(!data.next_max_id){$btn.hide().addClass("hidden")}}).fail(function(){alert("Unexpected server error")}).always(function(){$btn.button("reset");loading=false})});$(window).on("scroll",function(){if(loading||!$btn.data("next_max_id")){return}if($(window).scrollTop()+$(window).height()-$btn.outerHeight()>$btn.offset().top){$btn.trigger("click")}})});$("form","#popup-payment").on("submit",function(){$("#popup-payment").popupClose();$("#popup-alert").popup({shadow:true,modal:true,text:'<div class="text-center">Completing payment...</div>'})});(function(){var $page=$(".page.order");var $btnCheckAll=$(".js-btn-check-all",$page);var $btnCheckNotime=$(".js-btn-check-notime",$page);var $btnCheckNone=$(".js-btn-check-none",$page);var $chksUsername=$(".unit-username-select input:checkbox",$page);$btnCheckAll.on("click",function(e){e.preventDefault();$chksUsername.prop("checked",true)});$btnCheckNotime.on("click",function(e){e.preventDefault();$chksUsername.prop("checked",false).filter("[data-notime=true]").prop("checked",true)});$btnCheckNone.on("click",function(e){e.preventDefault();$chksUsername.prop("checked",false)})})();(function(){var $popup=$("#popup-reauth"),$btnReauth=$("[data-ui=btn-reauth]");$btnReauth.on("click",function(e){e.preventDefault();var $btn=$(this),username=$btn.data("username");$popup.trigger("popup.do-open");$popup.find("input[name=username]").val(username)})})();(function(){var $popup=$("#popup-time-transfer");var $form=$("form",$popup);var $sels=$(".js-sel-username",$form);var $selFrom=$("#inpUserFromId",$form);var $inpsTime=$(".js-inp-time",$form);var $inpTimeAll=$("#inpTimeAll",$form);var $btnsTimeTransfer=$("[data-ui=btn-time-transfer]");function updateNiceTime(userId,time,niceTime){var $acc=$(".account-entry[data-user-id="+userId+"]");var $timeOk=$(".payment-timer .label-ok",$acc);var $timeOver=$(".payment-timer .label-over",$acc);$timeOk.text(niceTime);if(time<=0){$timeOk.hide().addClass("hidden");$timeOver.show().removeClass("hidden")}else{$timeOver.hide().addClass("hidden");$timeOk.show().removeClass("hidden")}$sels.find("option[value="+userId+"]").each(function(){var $opt=$(this);$opt.text($opt.data("username")+" ("+niceTime+")")})}$form.on("timetransfer",function(e,data){updateNiceTime(data.userFromId,data.userFromTime,data.userFromNiceTime);updateNiceTime(data.userToId,data.userToTime,data.userToNiceTime)});$inpTimeAll.on("change",function(){if($inpTimeAll.prop("checked")){$inpsTime.prop("disabled",true).attr("data-disabled",true)}else{$inpsTime.prop("disabled",false).attr("data-disabled",false)}});$btnsTimeTransfer.on("click",function(e){e.preventDefault();var $btn=$(this),username=$btn.data("username");$popup.trigger("popup.do-open");$selFrom.find("option[data-username="+username+"]").prop("selected",true)});$popup.on("popup.close",function(){$inpsTime.prop("disabled",false).attr("data-disabled",false)})})();(function(){var $trydemoCont=$(".trydemo-cont"),$paymentCont=$(".payment-cont"),$sliderCont=$(".payment-slider-cont",$paymentCont),$slider=$(".payment-slider",$paymentCont),$items=$(".payment-item",$slider),$btnShow=$(".btn-show-packages",$trydemoCont),$btnExtra=$(".btn-extra-packages",$paymentCont),$btnNormal=$(".btn-normal-packages",$paymentCont);function resizeItems(){var itemW=($sliderCont.width()-18)/3;$slider.css({width:(itemW+9)*6+"px"});$items.css({width:itemW+"px"})}$btnShow.on("click",function(e){e.preventDefault();$trydemoCont.hide().addClass("hidden");$paymentCont.show().removeClass("hidden");resizeItems()});$btnExtra.on("click",function(e){e.preventDefault();$btnExtra.hide().addClass("hidden");$btnNormal.show().removeClass("hidden");$slider.stop().animate({left:$slider.width()/-2+"px"})});$btnNormal.on("click",function(e){e.preventDefault();$btnNormal.hide().addClass("hidden");$btnExtra.show().removeClass("hidden");$slider.stop().animate({left:"0"})});$(window).on("resize",resizeItems);resizeItems()})();(function(){var $worker=$(".worker"),$form=$("form",$worker),$formInputs=$("input, select, textarea, button:not(.btn-start-stop)",$form),$formNumbers=$("input[type=number]",$form),$formCheckboxes=$("input[type=checkbox]",$form),$fieldWraps=$(".form-group",$form),$botStartInfo=$(".alert.worker-start-info",$worker),$botStopReason=$(".alert.worker-stop-reason",$worker),$botErrors=$(".alert.worker-error",$worker),$btnStart=$(".btn-start",$worker),$btnStop=$(".btn-stop",$worker),$inpFollow=$("#inpFollow",$worker),$inpUnfollow=$("#inpUnfollow",$worker),$txtStatus=$(".status",$worker),$txtLikes=$(".count-likes",$worker),$txtComments=$(".count-comments",$worker),$txtFollows=$(".count-follows",$worker),$txtUnfollows=$(".count-unfollows",$worker),$time=$(".resource",$worker),$txtTime=$(".counter",$time),$trydemoCont=$(".trydemo-cont",$worker),$paymentCont=$(".payment-cont",$worker),$selSource=$("#selSource",$worker),$inpMinLikes=$("#inpMinLikes",$worker),$inpMaxLikes=$("#inpMaxLikes",$worker),$contTags=$(".activity-settings .tags",$worker),$tagsRow=$(".tags-row",$contTags),$inpTags=$("#inpTags",$contTags),$inpAddTags=$("#inpAddTags",$contTags),$btnAddTags=$(".btn-add-tags",$contTags),$btnDelTags=$(".btn-del-tags",$contTags),tplTag=$("#tplTag",$contTags).html(),$contComments=$(".activity-settings .comments",$worker),$commentsRow=$(".comments-row",$contComments),$inpComments=$("#inpComments",$contComments),$btnDelComments=$(".btn-del-comments",$contComments),tplComment=$("#tplComment",$contComments).html(),$contUsernames=$(".activity-settings .usernames",$worker),$usernamesRow=$(".usernames-row",$contUsernames),$btnDelUsernames=$(".btn-del-usernames",$contUsernames),tplUsername=$("#tplUsername",$contUsernames).html(),tplUsernameSel=$("#tplUsernameSelect",$contUsernames).html(),$contLocations=$(".activity-settings .locations",$worker),$locationsRow=$(".locations-row",$contLocations),$btnDelLocations=$(".btn-del-locations",$contLocations),tplLocation=$("#tplLocation",$contLocations).html(),tplLocationSel=$("#tplLocationSelect",$contLocations).html(),$btnReset=$(".btn-settings-reset",$worker),wStatus=$worker.data("status"),wDemo=$worker.data("demo"),statusTm=null;if(!$worker.size()){return}function updateStatus(){$.ajax({url:"/activity/status",data:{},type:"GET",contentType:"application/json",dataType:"json",cache:false,success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){wStatus=data.worker.status;$txtStatus.text(data.worker.status);$txtLikes.text(data.worker.likes||0);$txtComments.text(data.worker.comments||0);$txtFollows.text(data.worker.follows||0);$txtUnfollows.text(data.worker.unfollows||0);$txtTime.text(data.nicePaymentTime);if(data.paymentTime<=0){$time.removeClass("ok").addClass("over")}else{$time.removeClass("over").addClass("ok")}if(data.worker.stop_reason){$botStopReason.removeClass($botStopReason.data("alert-class"));$botStopReason.data("alert-class","alert-"+(data.worker.stop_reason_type||"success"));$botStopReason.addClass($botStopReason.data("alert-class"));$botStopReason.find(".stop-reason").text(data.worker.stop_reason).end().show().removeClass("hidden");if(data.worker.stop_reason_type==="error"){$botStopReason.find(".stop-error-help").show().removeClass("hidden")}}if(data.worker.client_action){var action=data.worker.client_action.action;var params=data.worker.client_action.params;switch(action){case"redirect":document.location=params.url;break}}}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(jqXHR,textStatus,errorThrown){},complete:function(){if(wStatus==="started"){startStatusUpdate()}else{onStop()}}})}function startStatusUpdate(){statusTm=setTimeout(updateStatus,1e3*15)}function stopStatusUpdate(){clearTimeout(statusTm)}function clearCounters(){$txtLikes.text("0");$txtComments.text("0");$txtFollows.text("0");$txtUnfollows.text("0")}function enableInputs(){$formInputs.filter(":not([data-disabled=1],[data-disabled=true])").prop("disabled",false);$tagsRow.find("> span a").removeClass("disabled");$commentsRow.find("> span a").removeClass("disabled");$usernamesRow.find("> span a").removeClass("disabled");$locationsRow.find("> span a").removeClass("disabled")}function disableInputs(){$formInputs.prop("disabled",true);$tagsRow.find("> span a").addClass("disabled");$commentsRow.find("> span a").addClass("disabled");$usernamesRow.find("> span a").addClass("disabled");$locationsRow.find("> span a").addClass("disabled")}function onStart(){wStatus="started";$txtStatus.text("started").removeClass("status-stopped").addClass("status-started");$btnStart.hide().addClass("hidden");$btnStop.show().removeClass("hidden");disableInputs();$botStopReason.hide().addClass("hidden");$botStopReason.find(".stop-error-help").hide().addClass("hidden");$botErrors.hide().addClass("hidden");$trydemoCont.hide().addClass("hidden");$paymentCont.show().removeClass("hidden");startStatusUpdate()}function onStop(){wStatus="stopped";$txtStatus.text("stopped").removeClass("status-started").addClass("status-stopped");$btnStop.hide().addClass("hidden");$btnStart.show().removeClass("hidden");enableInputs();stopStatusUpdate()}function checkMinMaxLikes(){var min=parseInt($inpMinLikes.val());var max=parseInt($inpMaxLikes.val());if(max>0&&min>max){alert("Error! "+'You have selected "Min. likes" more than "Max. likes".')}else if(min>0&&max>0&&min===max){alert("Warning! "+'You have selected the same value for both "Min. likes" and "Max. likes".')}else if(min>300){alert("Attention! "+'You have selected too high value for "Min. likes".')}}function onAddTags(e){e.preventDefault();var tags=helper.prepareTags($inpTags.val());var newTags=helper.prepareTags($inpAddTags.val());for(var i=0;i<newTags.length;i++){var tag=newTags[i];if(tags.indexOf(tag)===-1){tags.push(tag);$tagsRow.append(tplTag.replace(/%tag%/g,helper.escapeHtmlChars(tag)))}}$inpTags.val(tags.join("\n")).trigger("change");$inpAddTags.val("").focus()}function prepareConfig(config){$formNumbers.each(function(){var $inp=$(this);var name=$inp.attr("name");if(!config[name]){config[name]=$inp.data("default");$inp.val(config[name])}});$formCheckboxes.each(function(){var $inp=$(this);var name=$inp.attr("name");config[name]=config[name]!==undefined});return config}if(wStatus==="started"){onStart()}else{onStop()}$inpFollow.on("change",function(){if($(this).prop("checked")){$inpUnfollow.prop("checked",false)}});$inpUnfollow.on("change",function(){if($(this).prop("checked")){$inpFollow.prop("checked",false)}});$selSource.on("change",function(){var state=$(this).val()==="tag";$(".activity-settings .tags",$worker).css("display",state?"block":"none")});$inpMinLikes.on("change",checkMinMaxLikes);$inpMaxLikes.on("change",checkMinMaxLikes);$formInputs.on("change",function(){$(this).parents(".form-group.error").removeClass("error")});$("#inpTimeLimit").mask("99:99");$btnAddTags.on("click",onAddTags);$inpAddTags.on("keydown",function(e){if(e.which==13){onAddTags(e)}});$tagsRow.on("click","> span a",function(e){e.preventDefault();var $btn=$(this);var $tag=$btn.parent();var tag=$tag.data("tag");if($btn.hasClass("disabled")){return}$tag.remove();var tags=helper.prepareTags($inpTags.val());var newTags=[];for(var i=0;i<tags.length;i++){var t=tags[i];if(t!=tag){newTags.push(t)}}$inpTags.val(newTags.join("\n")).trigger("change")});$btnDelTags.on("click",function(e){e.preventDefault();$inpTags.val("").trigger("change");$tagsRow.find("> span").remove()});(function(){var $popup=$("#popup-activity-comments");var $inpCs=$(".js-inp-comments",$popup);var $btnClose=$(".js-btn-close",$popup);var $btnAdd=$(".js-btn-add",$popup);function swapAddCloseBtns(){if($.trim($inpCs.val())){$btnClose.hide();$btnAdd.show()}else{$btnAdd.hide();$btnClose.show()}}function emojifyComment($comment){var $commentLabel=$comment.find("> span");$commentLabel.html(helper.emojifyHtml($commentLabel.html()));return $comment}function emojifyComments(){$commentsRow.find("> span").each(function(){emojifyComment($(this))})}$popup.on("popup.open",function(){$inpCs.val("");swapAddCloseBtns();$popup.popupPos()});$inpCs.on("change paste keyup",function(){swapAddCloseBtns()});$btnAdd.on("click",function(e){e.preventDefault();var comments=helper.prepareComments($inpComments.val());var newComments=helper.prepareComments($inpCs.val());for(var i=0;i<newComments.length;i++){var comment=newComments[i];comment=emojione.shortnameToUnicode(comment);comments.push(comment);$commentsRow.append(emojifyComment($(_.template(tplComment)({comment:helper.escapeHtmlChars(comment)}))))}$inpComments.val(comments.join("\n")).trigger("change");$inpCs.val("");swapAddCloseBtns();$popup.trigger("popup.do-close")});$commentsRow.on("click","> span a",function(e){e.preventDefault();var $btn=$(this);var $comment=$btn.parent();var comment=$comment.data("comment");if($btn.hasClass("disabled")){return}$comment.remove();var comments=helper.prepareComments($inpComments.val());var newComments=[];for(var i=0;i<comments.length;i++){var c=comments[i];if(c!=comment){newComments.push(c)}}$inpComments.val(newComments.join("\n")).trigger("change")});$btnDelComments.on("click",function(e){e.preventDefault();$inpComments.val("").trigger("change");$commentsRow.find("> span").remove()});emojifyComments()})();(function(){var $popup=$("#popup-activity-usernames");var $txtError=$("[data-ui=txt-error]",$popup);var $txtStatus=$("[data-ui=txt-status]",$popup);var $inpSearch=$("[data-ui=inp-search]",$popup);var $btnSearch=$("[data-ui=btn-search]",$popup);var $loader=$("[data-ui=loader]",$popup);var $results=$("[data-ui=results]",$popup);var $btnClose=$("[data-ui=btn-close]",$popup);var $btnAdd=$("[data-ui=btn-add]",$popup);function showError(error){$txtError.html(error).show().removeClass("hidden")}function hideError(){$txtError.html("").hide().addClass("hidden")}function showStatus(status){$txtStatus.html(status).show().removeClass("hidden")}function hideStatus(){$txtStatus.html("").hide().addClass("hidden")}function cleanResults(all){if(all){$results.html("")}else{$("input[type=checkbox]:not(:checked)",$results).each(function(){$(this).closest(".unit-username-select").remove()})}}function swapAddCloseBtns(){if($("input[type=checkbox]:checked",$results).size()){$btnClose.addClass("hidden");$btnAdd.removeClass("hidden")}else{$btnAdd.addClass("hidden");$btnClose.removeClass("hidden")}}function searchUsernames(){hideError();hideStatus();$inpSearch.prop("disabled",true);$btnSearch.prop("disabled",true);$loader.removeClass("hidden");cleanResults();swapAddCloseBtns();$popup.popupPos();$.ajax({type:"GET",url:"/activity/settings/usernames/search",data:{q:$inpSearch.val()},dataType:"json",success:function(data){if(data.error){showError(data.error)}else if(data.data&&data.data.length){_.each(data.data,function(u){if($(".unit-username-select[data-id="+u.id+"]",$results).size()){return}$results.append(_.template(tplUsernameSel)(u))});$popup.popupPos()}},error:function(jqXHR,textStatus,errorThrown){showError("Unexpected server error")},complete:function(){$inpSearch.prop("disabled",false).focus();$btnSearch.prop("disabled",false);$loader.addClass("hidden")}})}$popup.on("popup.open",function(){hideError();hideStatus();$inpSearch.val("");$loader.addClass("hidden");cleanResults(true);swapAddCloseBtns();$popup.popupPos()});$inpSearch.on("keydown",function(e){if(e.which===13){searchUsernames()}});$btnSearch.on("click",function(){searchUsernames()});$results.on("change","input[type=checkbox]",function(){swapAddCloseBtns()});$btnAdd.on("click",function(){var usernames=[];$("input[type=checkbox]:checked",$results).each(function(){var $unit=$(this).closest(".unit-username-select");usernames.push({id:$unit.attr("data-id"),username:$unit.attr("data-username")})});hideError();hideStatus();$inpSearch.prop("disabled",true);$btnSearch.prop("disabled",true);$loader.removeClass("hidden");$btnAdd.prop("disabled",true);$popup.popupPos();$.ajax({type:"POST",url:"/activity/settings/usernames/add",data:{usernames:usernames},dataType:"json",success:function(data){if(data.status==="ok"){$usernamesRow.find("> span").remove();_.each(data.usernames,function(u){$usernamesRow.append(_.template(tplUsername)(u))});showStatus("Usernames added");$popup.trigger("popup.do-close")}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(jqXHR,textStatus,errorThrown){},complete:function(){$inpSearch.prop("disabled",false);$btnSearch.prop("disabled",false);$loader.addClass("hidden");$btnAdd.prop("disabled",false);$popup.popupPos()}})});$usernamesRow.on("click","> span a",function(e){e.preventDefault();var $btn=$(this);var $username=$btn.parent();var id=$username.attr("data-id");var username=$username.attr("data-username");if($btn.hasClass("disabled")){return}$.ajax({type:"POST",url:"/activity/settings/usernames/remove",data:{id:id},dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){$username.remove()}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(){alert("Unexpected server error")}})});$btnDelUsernames.on("click",function(e){e.preventDefault();$.ajax({type:"POST",url:"/activity/settings/usernames/reset",data:{},dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){$usernamesRow.find("> span").remove()}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(){alert("Unexpected server error")}})})})();(function(){var $popup=$("#popup-activity-locations");var $txtError=$(".js-txt-error",$popup);var $txtStatus=$(".js-txt-status",$popup);var $wgtMap=$(".js-wgt-map",$popup);var $wgtResults=$(".js-wgt-results",$popup);var $wgtLoader=$(".js-wgt-loader",$popup);var $inpLat=$(".js-inp-lat",$popup);var $inpLng=$(".js-inp-lng",$popup);var $inpAddr=$(".js-inp-address",$popup);var $btnFind=$(".js-btn-find",$popup);var $btnClose=$(".js-btn-close",$popup);var $btnAdd=$(".js-btn-add",$popup);function showError(error){$txtError.html(error).show()}function hideError(){$txtError.html("").hide()}function showStatus(status){$txtStatus.html(status).show()}function hideStatus(){$txtStatus.html("").hide()}var mapCenter=new google.maps.LatLng(parseFloat($inpLat.val())||0,parseFloat($inpLng.val())||0);var mapZoom=10;var map=null;var infowindow=new google.maps.InfoWindow({pixelOffset:new google.maps.Size(-1,0)});var geocoder=new google.maps.Geocoder;var mapLocsTmp={};var mapLocsSel={};var mapLocsAdd={};function selectLocation(locId){var loc=mapLocsTmp[locId];if(!loc){return}delete mapLocsTmp[locId];mapLocsSel[locId]=loc;loc._marker.setIcon(getMarkerIcon("sel"));loc._marker.setZIndex(google.maps.Marker.MAX_ZINDEX);$wgtResults.find("#location-"+locId).prop("checked",true).trigger("change")}function unselectLocation(locId){var loc=mapLocsSel[locId];if(!loc){return}delete mapLocsSel[locId];mapLocsTmp[locId]=loc;loc._marker.setIcon(getMarkerIcon("tmp"));$wgtResults.find("#location-"+locId).prop("checked",false).trigger("change")}function addLocation(locId){var loc=mapLocsSel[locId];if(!loc){return}delete mapLocsSel[locId];mapLocsAdd[locId]=loc;loc._marker.setIcon(getMarkerIcon("add"));$wgtResults.find("#location-"+locId).closest(".unit-location-select").remove()}function deleteLocation(locId){var loc=mapLocsAdd[locId];if(!loc){return}delete mapLocsAdd[locId];loc._marker.setMap(null);$locationsRow.find("> span[data-id="+locId+"] a").trigger("click")}function cleanLocations(locs){for(var locId in locs){if(!locs.hasOwnProperty(locId)){continue}locs[locId]._marker.setMap(null);$wgtResults.find(".unit-location[data-id="+locId+"]").remove();delete locs[locId]}}function getAddedLocations(){var locs=[];$locationsRow.find("> span").each(function(){var $loc=$(this);locs.push({id:$loc.attr("data-id"),name:$loc.attr("data-name"),latitude:$loc.attr("data-latitude"),longitude:$loc.attr("data-longitude")})});return locs}function populateAddedLocations(){var locs=getAddedLocations();for(var i=0;i<locs.length;i++){addLocationMarker(locs[i],mapLocsAdd,"add")}}function setSearchPosition(pos){$inpLat.val(pos.lat());$inpLng.val(pos.lng())}function renderMap(){$inpAddr.prop("disabled",false).focus();$btnFind.prop("disabled",false);$wgtLoader.hide();$wgtMap.show();$popup.popupPos();map=new google.maps.Map($wgtMap.get(0),{center:mapCenter,zoom:mapZoom,scrollwheel:false});google.maps.event.addListener(map,"click",function(e){$inpAddr.val("");map.panTo(e.latLng);setSearchPosition(e.latLng);searchLocations()});populateAddedLocations()}function getMarkerIcon(type){var url={tmp:"/img/marker-red-2x.png",sel:"/img/marker-orange-2x.png",add:"/img/marker-green-2x.png"};return{url:url[type],size:new google.maps.Size(24,36),scaledSize:new google.maps.Size(24,36),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(12,36)}}function getMarkerShape(){return{coords:[12,0,20,4,24,12,12,36,0,12,4,4],type:"poly"}}function addLocationMarker(loc,locs,type){locs=locs||mapLocsTmp;type=type||"tmp";var marker=new google.maps.Marker({map:map,position:{lat:parseFloat(loc.latitude),lng:parseFloat(loc.longitude)},title:loc.name,icon:getMarkerIcon(type),shape:getMarkerShape()});google.maps.event.addListener(marker,"click",function(){var content="<b>"+loc.name.replace(/\s/g,"&nbsp;")+"</b><br/>";var btnClass;var btnLabel;if(loc._media_count&&loc._media_count_str){content+="Media&nbsp;count:&nbsp;"+loc._media_count_str+"<br/>"}if(mapLocsTmp[loc.id]){btnClass="js-btn-loc-select";btnLabel="Select"}else if(mapLocsSel[loc.id]){btnClass="js-btn-loc-unselect";btnLabel="Unselect"}else if(mapLocsAdd[loc.id]){btnClass="js-btn-loc-delete";btnLabel="Delete"}content+='<a href="#" '+'class="'+btnClass+'" '+'data-loc-id="'+loc.id+'">'+btnLabel+"</a>";marker.setZIndex(google.maps.Marker.MAX_ZINDEX+1);infowindow.setContent(content);infowindow.open(marker.get("map"),marker)});loc._marker=marker;locs[loc.id]=loc}function codeAddress(){var addr=$inpAddr.val();if($.trim(addr)===""){map.panTo(mapCenter);map.setZoom(15);setSearchPosition(mapCenter);searchLocations();return}geocoder.geocode({address:addr},function(results,status){if(status===google.maps.GeocoderStatus.OK){map.panTo(results[0].geometry.location);map.setZoom(15);setSearchPosition(results[0].geometry.location);searchLocations()}else{showError("Address not found (status: "+status+")")}})}function swapAddCloseBtns(){if($("input[type=checkbox]:checked",$wgtResults).size()){$btnClose.hide();$btnAdd.show()}else{$btnAdd.hide();$btnClose.show()}}function searchLocations(){hideError();hideStatus();$inpAddr.prop("disabled",true);$btnFind.prop("disabled",true);$wgtLoader.show();cleanLocations(mapLocsTmp);swapAddCloseBtns();$.ajax({type:"GET",url:"/activity/settings/locations/search",data:{lat:$inpLat.val(),lng:$inpLng.val()},dataType:"json",success:function(data){if(data.error){showError(data.error)}else if(data.data&&data.data.length){$wgtResults.show();_.each(data.data,function(l){if(mapLocsSel[l.id]||mapLocsAdd[l.id]){return}if(l._media_count===0){return}$wgtResults.append(_.template(tplLocationSel)(l));addLocationMarker(l)});$popup.popupPos()}},error:function(jqXHR,textStatus,errorThrown){showError("Unexpected server error")},complete:function(){$inpAddr.prop("disabled",false);$btnFind.prop("disabled",false);$wgtLoader.hide()}})}function searchWideLocations(){hideError();hideStatus();$inpAddr.prop("disabled",true);$btnFind.prop("disabled",true);$wgtLoader.show();cleanLocations(mapLocsTmp);swapAddCloseBtns();var addr=$inpAddr.val();var data={};if(addr){data.near=addr}else{var bs=map.getBounds();var sw=bs.getSouthWest();var ne=bs.getNorthEast();data.sw=sw.lat()+","+sw.lng();data.ne=ne.lat()+","+ne.lng()}$.ajax({type:"GET",url:"/activity/settings/locations/search/wide",data:data,dataType:"json",success:function(data){if(data.error){showError(data.error)}else if(data.results&&data.results.length){$wgtResults.show();$inpAddr.val("");_.each(data.results,function(l){if(mapLocsSel[l.id]||mapLocsAdd[l.id]){return}if(l._media_count===0){return}$wgtResults.append(_.template(tplLocationSel)(l));addLocationMarker(l)});$popup.popupPos();if(data.bounds&&data.bounds.sw&&data.bounds.ne){map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(data.bounds.sw.lat,data.bounds.sw.lng),new google.maps.LatLng(data.bounds.ne.lat,data.bounds.ne.lng)))}}},error:function(jqXHR,textStatus,errorThrown){showError("Unexpected server error")},complete:function(){$inpAddr.prop("disabled",false);$btnFind.prop("disabled",false);$wgtLoader.hide()}})}$popup.on("click",".js-btn-loc-select",function(e){e.preventDefault();var locId=$(this).data("loc-id");selectLocation(locId);infowindow.close()});$popup.on("click",".js-btn-loc-unselect",function(e){e.preventDefault();var locId=$(this).data("loc-id");unselectLocation(locId);infowindow.close()});$popup.on("click",".js-btn-loc-delete",function(e){e.preventDefault();var locId=$(this).data("loc-id");deleteLocation(locId);infowindow.close()});
    $popup.on("popup.open",function(){hideError();hideStatus();$inpAddr.val("");$wgtLoader.hide();cleanLocations(mapLocsTmp);cleanLocations(mapLocsSel);swapAddCloseBtns();$popup.popupPos()});$popup.one("popup.open",function(){function onLocationSuccess(pos){mapCenter=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);mapZoom=15;setSearchPosition(mapCenter);renderMap()}function onLocationError(err){renderMap()}$inpAddr.prop("disabled",true);$btnFind.prop("disabled",true);$wgtLoader.show();if(navigator.geolocation){navigator.geolocation.getCurrentPosition(onLocationSuccess,onLocationError)}else{renderMap()}});$inpAddr.on("keydown",function(e){if(e.which===13){searchWideLocations()}});$btnFind.on("click",function(){searchWideLocations()});$wgtResults.on("change","input[type=checkbox]",function(){var $chk=$(this);var $loc=$chk.closest(".unit-location-select");if($chk.prop("checked")===true){selectLocation($loc.attr("data-id"))}else{unselectLocation($loc.attr("data-id"))}swapAddCloseBtns()});$btnAdd.on("click",function(){var locations=[];_.each(mapLocsSel,function(l){var loc={id:l.id,name:l.name,latitude:l.latitude,longitude:l.longitude};if(l.foursquare_v2_id){loc.foursquare_v2_id=l.foursquare_v2_id}locations.push(loc)});hideError();hideStatus();$inpAddr.prop("disabled",true);$btnFind.prop("disabled",true);$wgtLoader.show();$btnAdd.prop("disabled",true);$.ajax({type:"POST",url:"/activity/settings/locations/add",data:{locations:locations},dataType:"json",success:function(data){if(data.status==="ok"){$locationsRow.find("> span").remove();_.each(data.locations,function(l){$locationsRow.append(_.template(tplLocation)(l));addLocation(l.id)});showStatus("Locations added");$popup.trigger("popup.do-close")}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(jqXHR,textStatus,errorThrown){showError("Unexpected server error")},complete:function(){$inpAddr.prop("disabled",false);$btnFind.prop("disabled",false);$wgtLoader.hide();$btnAdd.prop("disabled",false)}})});$locationsRow.on("click","> span a",function(e){e.preventDefault();var $btn=$(this);var $location=$btn.parent();var id=$location.attr("data-id");var location=$location.attr("data-name");if($btn.hasClass("disabled")){return}$.ajax({type:"POST",url:"/activity/settings/locations/remove",data:{id:id},dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){$location.remove();deleteLocation(id)}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(){alert("Unexpected server error")}})});$btnDelLocations.on("click",function(e){e.preventDefault();$.ajax({type:"POST",url:"/activity/settings/locations/reset",data:{},dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){$locationsRow.find("> span").remove();cleanLocations(mapLocsAdd)}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(){alert("Unexpected server error")}})})})();$(".close",$botStartInfo).on("click",function(){$.cookie("bot_info_start_closed",true,{expires:30,path:"/"})});$formInputs.on("change",function(){if(wDemo){return}var data={config:prepareConfig(helper.formArrayToObject($form.serializeArray()))};$.ajax({url:"/activity/settings/save",data:JSON.stringify(data),type:"POST",contentType:"application/json",dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status!=="ok"){if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(){alert("Unexpected server error")}})});$btnReset.on("click",function(e){e.preventDefault();if(wDemo){document.location.reload(true);return}if(!confirm("WARNING!\n\nAre you sure you want to reset all settings to default values?")){return}$.ajax({url:"/activity/settings/reset",data:JSON.stringify({}),type:"POST",contentType:"application/json",dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){document.location.reload(true)}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(){alert("Unexpected server error")}})});$btnStart.on("click",function(e){e.preventDefault();if(wDemo){return}$btnStart.button("loading");$fieldWraps.removeClass("error");$tagsRow.find("> span").removeClass("error");$commentsRow.find("> span").removeClass("error");var data={config:prepareConfig(helper.formArrayToObject($form.serializeArray()))};disableInputs();$.ajax({url:"/activity/start",data:JSON.stringify(data),type:"POST",contentType:"application/json",dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){onStart();clearCounters();if(!$.cookie("bot_info_start_closed",Boolean)){$botStartInfo.show().removeClass("hidden")}}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}if(data.validationErrors){alert("Check your settings");for(var j=0;j<data.validationErrors.length;j++){var err=data.validationErrors[j];var errText=_.isObject(err)&&err.msg?err.msg:null;var errField=_.isObject(err)&&err.param?err.param:null;if(errText!==null&&errField!==null){var $fieldWrap=$fieldWraps.filter("[data-field="+errField+"]");$fieldWrap.addClass("error")}}}if(data.errorTags){$tagsRow.find("> span").each(function(){var $tag=$(this);var tag=$tag.attr("data-tag");if(data.errorTags.indexOf(tag)!==-1){$tag.addClass("error");$fieldWraps.filter("[data-field=tags]").addClass("error")}})}if(data.errorComments){$commentsRow.find("> span").each(function(){var $comment=$(this);var comment=$comment.attr("data-comment");if(data.errorComments.indexOf(comment)!==-1){$comment.addClass("error");$fieldWraps.filter("[data-field=comments]").addClass("error")}})}}},error:function(){},complete:function(){$btnStart.button("reset");if(wStatus!=="started"){enableInputs()}}})});$btnStop.on("click",function(e){e.preventDefault();if(wDemo){return}$btnStop.button("loading");var data={};$.ajax({url:"/activity/stop",data:JSON.stringify(data),type:"POST",contentType:"application/json",dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status==="ok"){onStop()}else{if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}}},error:function(){},complete:function(){$btnStop.button("reset")}})})})();(function(){var $accs=$(".account-entry"),$btnStartAll=$("#btn-start-all"),$btnStopAll=$("#btn-stop-all"),$btnsStart=$(".btn-start",$accs),$btnsStop=$(".btn-stop",$accs),$countStarted=$("#count-started"),$countStopped=$("#count-stopped"),$popupTimeTransfer=$("#popup-time-transfer");function showStatusAlert($alert,statusType,statusMessage){var status="Activity automatically stopped";if(statusMessage){status+=":<br/>"+statusMessage}if(statusType==="error"){status+="<br/><br/>(click on the icon to get more info)"}$alert.removeClass($alert.attr("data-alert-class"));$alert.attr("data-alert-class","alert-"+(statusType||"success"));$alert.addClass($alert.attr("data-alert-class"));$alert.attr("data-original-title",status);$alert.css("display","inline-block").removeClass("hidden")}function hideStatusAlert($alert){$alert.hide().addClass("hidden")}function processStatusForAll(data){if(data.debug){console.log(data.debug)}if(data.error){alert(data.error)}else if(data.errors){alert(data.errors.join("\n"))}if(data.hasOwnProperty("started"))$countStarted.text(data.started);if(data.hasOwnProperty("stopped"))$countStopped.text(data.stopped);if(data.results&&data.results.length){var usersErrors=[];for(var i=0,s=data.results[i];i<data.results.length;i++,s=data.results[i]){if(s.status){$accs.filter('[data-user-id="'+s.user_id+'"]').trigger("status.activity",s.status)}else{if(s.error){usersErrors.push(s.username+": "+s.error)}else if(s.errors){usersErrors.push(s.username+": "+s.errors.join("; "))}if(s.validationErrors){usersErrors.push(s.username+": Check account settings")}if(s.errorTags){usersErrors.push(s.username+": Check account settings")}if(s.errorComments){usersErrors.push(s.username+": Check account settings")}}}if(usersErrors.length){alert("Accounts with errors:\n\n"+usersErrors.join("\n"))}}}function updateStatusForAll(){$.ajax({url:"/account/activity/status/all",data:{},type:"GET",contentType:"application/json",dataType:"json",cache:false,success:function(data){processStatusForAll(data)},error:function(jqXHR,textStatus,errorThrown){},complete:function(){setTimeout(function(){updateStatusForAll()},1e3*15)}})}$btnStartAll.on("click",function(e){e.preventDefault();$btnStartAll.button("loading");$btnStopAll.button("loading");$btnsStart.button("loading");$btnsStop.button("loading");var data={};$.ajax({url:"/account/activity/start/all",data:JSON.stringify(data),type:"POST",contentType:"application/json",dataType:"json",success:function(data){processStatusForAll(data)},error:function(){},complete:function(){$btnStartAll.button("reset");$btnStopAll.button("reset");$btnsStart.button("reset");$btnsStop.button("reset")}})});$btnStopAll.on("click",function(e){e.preventDefault();$btnStartAll.button("loading");$btnStopAll.button("loading");$btnsStart.button("loading");$btnsStop.button("loading");var data={};$.ajax({url:"/account/activity/stop/all",data:JSON.stringify(data),type:"POST",contentType:"application/json",dataType:"json",success:function(data){processStatusForAll(data)},error:function(){},complete:function(){$btnStartAll.button("reset");$btnStopAll.button("reset");$btnsStart.button("reset");$btnsStop.button("reset")}})});$accs.each(function(){var $acc=$(this),$btnStart=$(".btn-start",$acc),$btnStop=$(".btn-stop",$acc),$status=$(".status",$acc),$statusText=$(".status-text",$status),$statusAlert=$(".stat-alert",$status),$timeStart=$(".time-start",$acc),$timeStop=$(".time-stop",$acc),$timeOk=$(".payment-timer .label-ok",$acc),$timeOver=$(".payment-timer .label-over",$acc),$txtLikes=$(".count-likes",$acc),$txtComments=$(".count-comments",$acc),$txtFollows=$(".count-follows",$acc),$txtUnfollows=$(".count-unfollows",$acc);var userId=$acc.data("user-id"),username=$acc.data("username");$acc.on("status.activity",function(e,data){$acc.trigger(data.status+".activity",data);$timeStart.text(data.start_date||"-");$timeStop.text(data.stop_date||"-");$timeOk.text(data.nicePaymentTime);if(data.paymentTime<=0){$timeOk.hide().addClass("hidden");$timeOver.show().removeClass("hidden")}else{$timeOver.hide().addClass("hidden");$timeOk.show().removeClass("hidden")}$txtLikes.text(data.likes);$txtComments.text(data.comments);$txtFollows.text(data.follows);$txtUnfollows.text(data.unfollows);if(data.client_action){var action=data.client_action.action;var params=data.client_action.params;switch(action){case"redirect":document.location=params.url;break}}$popupTimeTransfer.find(".js-sel-username option[value="+userId+"]").text(username+" ("+data.nicePaymentTime+")")});$acc.on("started.activity",function(){$status.removeClass("status-stopped").addClass("status-started");$statusText.text("started");$btnStart.hide().addClass("hidden");$btnStop.show().removeClass("hidden");hideStatusAlert($statusAlert)});$acc.on("stopped.activity",function(e,data){$status.removeClass("status-started").addClass("status-stopped");$statusText.text("stopped");$btnStop.hide().addClass("hidden");$btnStart.show().removeClass("hidden");if(data.stop_reason){showStatusAlert($statusAlert,data.stop_reason_type||"success",data.stop_reason)}});$statusAlert.on("click",function(){if($statusAlert.attr("data-alert-class")==="alert-error"){$("#popup-activity-error-help").trigger("popup.do-open")}});$btnStart.on("click",function(e){e.preventDefault();$btnStart.button("loading");var data={};$.ajax({url:"/account/activity/start/"+userId,data:JSON.stringify(data),type:"POST",contentType:"application/json",dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status&&data.status.status==="started"){$acc.trigger("status.activity",data.status)}else{if(data.error){alert(data.username+": "+data.error)}else if(data.errors){alert(data.username+": "+data.errors.join("; "))}if(data.validationErrors){alert(data.username+": Check account settings")}if(data.errorTags){alert(data.username+": Check account settings")}if(data.errorComments){alert(data.username+": Check account settings")}}},error:function(){},complete:function(){$btnStart.button("reset")}})});$btnStop.on("click",function(e){e.preventDefault();$btnStop.button("loading");var data={};$.ajax({url:"/account/activity/stop/"+userId,data:JSON.stringify(data),type:"POST",contentType:"application/json",dataType:"json",success:function(data){if(data.debug){console.log(data.debug)}if(data.status&&data.status.status==="stopped"){$acc.trigger("status.activity",data.status)}else{if(data.error){alert(data.username+": "+data.error)}else if(data.errors){alert(data.username+": "+data.errors.join("; "))}if(data.validationErrors){alert(data.username+": Check account settings")}if(data.errorTags){alert(data.username+": Check account settings")}if(data.errorComments){alert(data.username+": Check account settings")}}},error:function(){},complete:function(){$btnStop.button("reset")}})})});if($accs.size())updateStatusForAll()})()});
